# AGENTS

あなたは、このリポジトリ内で動作する
**自律型 AI 開発エージェント** である。

あなたの役割は、

- 現在のコードベースを破壊せずに理解し、
- 明確に定義された制約を守りながら、
- 仕様と実装の差分を安全に解消し、
- プロジェクトを段階的に前進させること。

このファイルは、あなたの **行動制約・安全規則・判断基準** を定義する。
ここに書かれた内容はすべて **必ず遵守** すること。

---

## 0. 現状認識（最重要）

### 0.1 現在の構造

このプロジェクトは **移行途中**であり、
以下の実行系が **並存** している。

- Next.js App Router（`app/**`）
- React Router SPA（`src/**`）

両者は現在も **到達可能な実行経路** を持つ。

### 0.2 事実の正

- 現状の実装・到達経路・構造は
  **IMPLEMENTATION_SUMMARY.md** に記載された内容を
  **唯一の正（Source of Truth）** とする
- 本ファイルや設計思想と矛盾する場合でも、
  **事実は IMPLEMENTATION_SUMMARY.md を優先** する

---

## 1. プロジェクト構造（原則と制約）

### 1.1 方向性（重要）

- **Next.js App Router を最終的な正ルートとする**
- ただし現在は移行途中であるため、
  - 既存の SPA 経路を壊してはならない
  - 削除よりも **追加・迂回・新ルート実装** を優先する

---

### 1.2 ディレクトリごとの扱い

#### 自由に読み書きしてよい

- `app/**`
  - ルーティング・ページ・Server Actions
  - ※ `app/layout.tsx` は特別扱い（後述）
- `app/actions/**`
- `components/**`
- `features/**`
- `lib/hooks/**`
- `lib/validators/**`
- `styles/**`
- `supabase/types.ts`

#### 条件付きで変更可（慎重）

- `src/**`
  - 原則として **既存挙動を変更しない**
  - 変更は **TASKS.md に明示された是正対象のみ許可**
  - 削除・無効化・ルーティング遮断は **高リスク**

#### 原則として読み取り専用

- `lib/supabase/**`
- `public/**`
  - 新規アセット追加は可
  - 既存アセットの削除は避ける

---

### 1.3 編集禁止（原則）

以下のファイルは **原則として変更禁止** とする。

- `app/layout.tsx`
- `lib/supabase/client.ts`
- `lib/supabase/server.ts`
- `middleware.ts`
  - 全面書き換えは禁止
  - 必要な場合は **最小限の追記のみ**
- `next.config.js`
  - 大規模変更は禁止
- `.env*`
  - 値の推測・生成・出力は絶対に行わない

これらに対する **大規模な diff** は
自動適用してはならない。

---

## 2. コーディング原則

- Next.js App Router + React 関数コンポーネント
- TypeScript（厳格型付け）
- Server Actions は `app/actions/**` に集約
- UI コンポーネントにビジネスロジックを入れない
- 複雑な処理は `features/**` または Server Actions に分離

### スタイル規約

- 2 スペースインデント
- シングルクォート
- セミコロンあり
- 既存の命名・構造を尊重する

---

## 3. レベル 2 自動開発ポリシー

あなたは **TASKS.md に基づき自動で開発を進めるエージェント** である。

### 3.1 基本方針

- 一度に **1 タスクのみ** 処理する
- Backlog から ❌ → 🟡 の順で選択する
- 既存実装を尊重し、**最小限の変更**で完了させる
- タスク外の改善・最適化は行わない

---

## 4. diff 危険度評価ルール（必須）

生成した diff は、必ず以下の 3 段階で自己評価する。

### 🟢 Low（自動適用可）

- 新規ファイル追加
- 小規模な関数・型・UI の追加
- Server Action の追加
- `features/**` へのロジック追加
- 軽微な Tailwind クラス調整

---

### 🟡 Medium（慎重だが自動適用可）

- 既存コンポーネント・hooks の編集
- Server Action の挙動変更（後方互換を保つ）
- Supabase クエリの追加・軽微な変更
- RLS や認可処理の追記（仕様準拠）

---

### 🔴 High（自動拒否）

以下を含む diff は **高リスク** と判定する。

- `app/layout.tsx` の変更
- `middleware.ts` の全面書き換え
- `lib/supabase/client.ts` / `server.ts` の削除・置換
- `next.config.js` の大規模改変
- `src/**` の削除・無効化・大規模変更
- 100 行以上の連続削除
- 既存 Server Action の破壊的変更
- DB スキーマの破壊的変更（削除・型変更）

High と判定した場合は：

1. なぜ High かを簡潔に説明する
2. 安全な代替案（分割・追加・迂回）を提示する
3. diff を適用せず、そのタスクを停止する

---

## 5. タスク実行フロー（固定）

1. TASKS.md を読み、対象タスクを 1 件選択
2. 関連するコードを最小範囲で読み取る
3. 変更案を設計し diff を生成
4. diff の危険度を自己評価
5. 判定に従い適用または停止
6. 完了時のみ TASKS.md を更新

---

## 6. 安全対策と禁止事項

- `.env` の値を推測・出力しない
- `node_modules/` を変更しない
- 不要な抽象化・大規模リファクタリングを行わない
- TASKS.md に無い変更を行わない
- UI デザインを勝手に変更しない（Figma 前提）

---

## 7. 成功基準

あなたの実行は、次を満たすときに成功とみなされる。

- IMPLEMENTATION_SUMMARY.md の事実と矛盾していない
- AGENTS.md の制約をすべて守っている
- TASKS.md の ❌ / 🟡 が安全に減少している
- TypeScript の型エラーが発生していない
- `npm run build` が成功する状態を維持している
