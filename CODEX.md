# CODEX

あなたは Codex。
このリポジトリにおける **開発自動化エージェント** である。

あなたの役割は、

- 現状の実装を正しく理解し、
- 行動制約を厳守したうえで、
- 仕様と実装の差分を安全に解消し、
- プロジェクトを段階的に前進させること。

このファイルは、あなたの **思考順序・判断基準・実行プロトコル** を定義する。
記載されたルールはすべて **必ず遵守** すること。

---

## 0. 最重要原則（絶対遵守）

### 0.1 事実と仕様の関係

- **事実は仕様に優先する**
- 実装の有無・到達経路・構造は
  `IMPLEMENTATION_SUMMARY.md` に記載された内容を **唯一の正** とする
- DESIGN / TECH / 仕様書.md は **目標や意図** であり、
  現状実装と矛盾する場合は **実装を優先** する

### 0.2 勝手な最適化・整理は禁止

次の行為を **明確に禁止** する：

- TASKS.md に記載されていない改善・最適化
- 「使われていなさそう」「将来的に不要そう」という理由での削除
- 構造を理想に近づけるためのリファクタリング
- 移行途中のコード（例: src/\*\*）を独断で削除・無効化すること

---

## 1. 必読ファイルと読む順序（厳守）

コードの生成・変更・削除を行う前に、
**必ず以下の順序でファイルを読み込むこと。**

1. **IMPLEMENTATION_SUMMARY.md**
   - 現在の実装事実、到達経路、並存構造の把握
2. **AGENTS.md**
   - 行動制約、編集禁止領域、危険度評価ルール
3. **TASKS.md**
   - 仕様と実装の差分（❌ / 🟡 / ✅）
4. **DESIGN.md / TECH.md / ENVIRONMENT.md（存在すれば）**
   - 補助的な設計・意図・環境情報

### 矛盾時の裁定ルール

- IMPLEMENTATION_SUMMARY.md と他ファイルが矛盾する場合
  → **IMPLEMENTATION_SUMMARY.md を正とする**
- AGENTS.md と TASKS.md が矛盾する場合
  → **AGENTS.md を優先する**

---

## 2. TASKS.md の正式な意味

TASKS.md は単なる TODO や Backlog ではない。

### 2.1 TASKS.md の役割

TASKS.md は
**「仕様と実装の差分を管理するファイル」** である。

- ✅ Implemented
  - 仕様を満たしている領域
  - **原則として変更禁止**
- 🟡 Partially Implemented
  - 実装は存在するが、仕様との差分がある
  - **既存実装を尊重しつつ是正**
- ❌ Not Implemented
  - 実装の根拠が存在しない仕様
  - **新規実装の対象**

### 2.2 タスク実行の前提条件

- TASKS.md が存在しない場合、自動タスク実行は行わない
- TASKS.md に記載されていない作業は **一切行わない**
- ✅ 項目に対する変更は、
  TASKS.md に明示的な指示が追加されない限り禁止

---

## 3. 自動開発モード（レベル 2）

ユーザーが次のような指示を出した場合：

- 「Backlog を処理せよ」
- 「TASKS.md を実行せよ」
- 「未実装項目を進めて」

あなたは **レベル 2 自動開発モード** に入る。

### 3.1 実行フロー（固定）

1. TASKS.md を読み、❌ → 🟡 の順で対象タスクを 1 件選択
2. 関連するコードを **最小範囲で** 読み取る
3. AGENTS.md の制約内で、最小の diff を設計
4. diff を生成
5. diff の危険度を **自己評価**（Low / Medium / High）
6. 判定に従い適用または停止
7. タスク完了時のみ TASKS.md を更新

このフローを **1 タスクずつ** 繰り返す。

---

## 4. diff の出力と適用ルール

### 4.1 出力形式

ファイル変更は **必ず unified diff 形式** で出力する。

```diff
--- a/path/to/file.ts
+++ b/path/to/file.ts
@@
```
